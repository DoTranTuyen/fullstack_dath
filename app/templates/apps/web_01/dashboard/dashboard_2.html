{% extends 'base/base.html' %}
{% import "/apps/web_01/commom/macros.html" as macros %}
{% block body %}
<div class="row">
    <div class="col-xl-3 col-xxl-3 col-lg-6 col-md-6 col-sm-6">
        <div class="widget-stat card">
            <div class="card-body p-4">
                <div class="media ai-icon">
                    <span class="mr-3 bgl-primary text-primary">
                        <i class="fa fa-shopping-cart"></i>
                    </span>
                    <div class="media-body mx-2">
                        <h3 class="mb-0 text-black"><span class="counter ml-0">{{ total_orders_today }}</span></h3>
                        <p class="mb-0">Đơn hàng hôm nay</p>
                        <small>Tổng số đơn hàng trong ngày</small>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-xl-3 col-xxl-3 col-lg-6 col-md-6 col-sm-6">
        <div class="widget-stat card">
            <div class="card-body p-4">
                <div class="media ai-icon">
                    <span class="mr-3 bgl-warning text-warning">
                        <i class="fa fa-money-bill-alt"></i>
                    </span>
                    <div class="media-body mx-2">
                        <h3 class="mb-0 text-black">{{ macros.format_currency(revenue_today) }}</h3>
                        <p class="mb-0">Doanh thu hôm nay</p>
                        <small>Tổng doanh thu trong ngày</small>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-xl-3 col-xxl-3 col-lg-6 col-md-6 col-sm-6">
        <div class="widget-stat card">
            <div class="card-body p-4">
                <div class="media ai-icon">
                    <span class="mr-3 bgl-success text-success">
                        <i class="fa fa-chart-line"></i>
                    </span>
                    <div class="media-body mx-2">
                        <h3 class="mb-0 text-black">{{ macros.format_currency(revenue_month) }}</h3>
                        <p class="mb-0">Doanh thu tháng</p>
                        <small>Tổng doanh thu trong tháng</small>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-xl-3 col-xxl-3 col-lg-6 col-md-6 col-sm-6">
        <div class="widget-stat card">
            <div class="card-body p-4">
                <div class="media ai-icon">
                    <span class="mr-3 bgl-danger text-danger">
                        <i class="fa fa-table"></i>
                    </span>
                    <div class="media-body mx-2">
                        <h3 class="mb-0 text-black">
                            <span class="counter ml-0">{{ tables_status.occupied }}</span>/{{ tables_status.available + tables_status.occupied + tables_status.reserved }}
                        </h3>
                        <p class="mb-0">Bàn đang sử dụng</p>
                        <small>Số bàn đang phục vụ khách</small>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Biểu đồ doanh thu 7 ngày gần nhất -->
<div class="row">
    <div class="col-xl-8 col-lg-12">
        <div class="card">
            <div class="card-header border-0 pb-0">
                <h4 class="card-title">Doanh thu 7 ngày gần nhất</h4>
            </div>
            <div class="card-body">
                <canvas id="revenueChart" height="150"></canvas>
            </div>
        </div>
    </div>
    <div class="col-xl-4 col-lg-12">
        <div class="card">
            <div class="card-header border-0 pb-0">
                <h4 class="card-title">Tỷ lệ đơn hàng theo trạng thái</h4>
            </div>
            <div class="card-body">
                <canvas id="orderStatusChart" height="230"></canvas>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-xl-8 col-xxl-8 col-lg-8">
        <div class="card">
            <div class="card-header border-0 pb-0">
                <h4 class="card-title">Sản phẩm bán chạy</h4>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-responsive-md">
                        <thead>
                            <tr>
                                <th>STT</th>
                                <th>Tên sản phẩm</th>
                                <th>Số lượng đã bán</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for item in best_selling %}
                            <tr>
                                <td>{{ loop.index }}</td>
                                <td>{{ item.product__name }}</td>
                                <td>{{ item.total_sold }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    <div class="col-xl-4 col-xxl-4 col-lg-4">
        <div class="card">
            <div class="card-header border-0 pb-0">
                <h4 class="card-title">Cảnh báo tồn kho</h4>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-responsive-md">
                        <thead>
                            <tr>
                                <th>Nguyên liệu</th>
                                <th>Tồn kho</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for item in low_stock_items %}
                            <tr>
                                <td>{{ item.name }}</td>
                                <td>
                                    <span class="badge badge-outline-danger">{{ item.quantity_in_stock }} {{ item.unit }}</span>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-xl-6 col-lg-12">
        <div class="card">
            <div class="card-header border-0 pb-0">
                <h4 class="card-title">Doanh thu theo danh mục</h4>
            </div>
            <div class="card-body">
                <canvas id="categoryRevenueChart" height="200"></canvas>
            </div>
        </div>
    </div>
       <div class="col-xl-6 col-lg-12">
        <div class="card">
            <div class="card-header border-0 pb-0">
                <h4 class="card-title">Tồn kho nguyên liệu chính</h4>
            </div>
            <div class="card-body">
                <canvas id="ingredientStockChart" height="200"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- Biểu đồ doanh thu theo danh mục và tồn kho nguyên liệu -->
<div class="row">
    <div class="col-lg-6">
        <div class="card">
            <div class="card-header border-0 pb-0">
                <h4 class="card-title">Khách hàng</h4>
            </div>
            <div class="card-body">
                <ul class="nav nav-tabs mb-3" role="tablist">
                <li class="nav-item">
                    <button class="nav-link active" data-mode="day">Ngày</button>
                </li>
                <li class="nav-item">
                    <button class="nav-link" data-mode="week">Tuần</button>
                </li>
                <li class="nav-item">
                    <button class="nav-link" data-mode="month">Tháng</button>
                </li>
            </ul>

            <canvas id="retentionChart" height="120"></canvas>
            </div>
        </div>
    </div>

    <div class="col-lg-6">
        <div class="card">
            <div class="card-header border-0 pb-0">
                <h4 class="card-title">Nhập xuất kho</h4>
            </div>
            <div class="card-body">
                <ul class="nav nav-tabs mb-3" role="tablist">
                    <li class="nav-item">
                        <button class="nav-link active" data-mode="day" data-chart="inventory">Ngày</button>
                    </li>
                    <li class="nav-item">
                        <button class="nav-link" data-mode="week" data-chart="inventory">Tuần</button>
                    </li>
                    <li class="nav-item">
                        <button class="nav-link" data-mode="month" data-chart="inventory">Tháng</button>
                    </li>
                </ul>

                <canvas id="inventoryChart" height="120"></canvas>
            </div>
        </div>
    </div>

</div>

<!-- Trạng thái bàn - Phiên bản cải tiến -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header border-0 pb-0 d-flex justify-content-between align-items-center">
                <h4 class="card-title">Bàn</h4>
                <div class="d-flex align-items-center">
                    <span class="badge badge-outline-success me-2"><i class="fa fa-check-circle"></i> Trống</span>
                    <span class="badge badge-outline-danger me-2"> <i class="fa fa-users"></i> Đang sử dụng</span>
                    <span class="badge badge-outline-warning"><i class="fa fa-clock"></i> Đã đặt</span>
                </div>
            </div>
            <div class="card-body">
                <div class="row">
                    {% for table in tables %}
                    <div class="col-xl-2 col-lg-3 col-md-4 col-sm-6 mb-3">
                        <div class="card text-center h-100 {% if table.status == 'available' %}border-success{% elif table.status == 'occupied' %}border-danger{% else %}border-warning{% endif %}">
                            <div class="card-body p-2">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <h5 class="card-title mb-0">Bàn {{ table.table_number }}</h5>
                                    <span class="badge {% if table.status == 'available' %}badge-outline-success{% elif table.status == 'occupied' %}badge-outline-danger{% else %}badge-outline-warning{% endif %}">
                                        {% if table.status == 'available' %}
                                            <i class="fa fa-check-circle"></i> Trống
                                        {% elif table.status == 'occupied' %}
                                            <i class="fa fa-users"></i> Đang sử dụng
                                        {% else %}
                                            <i class="fa fa-clock"></i> Đã đặt
                                        {% endif %}
                                    </span>
                                </div>
                                
                                {% if table.status == 'occupied' and table.current_session %}
                                <div class="d-flex justify-content-between align-items-center">
                                    <small class="text-muted">
                                        <i class="fa fa-clock"></i> {{ table.current_session.started_at.strftime('%d/%m/%Y %H:%M') }}
                                    </small>
                                </div>
                                <a href="{{url('web_01:service_list')}}?table={{table.id}}" class='btn btn-primary light btn-sm mt-2'><i class="fa-solid fa-location-arrow"></i></a>
                                {% endif %}
                               
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block script %}
<script>
        document.addEventListener('DOMContentLoaded', function() {

        // Dữ liệu nhập xuất kho
        const inventoryData = {
            day: {{ inventory_day|tojson }},
            week: {{ inventory_week|tojson }},
            month: {{ inventory_month|tojson }}
        };

        const inventoryCtx = document.getElementById('inventoryChart').getContext('2d');

        // Tính max cho trục Y
        const allImports = inventoryData.day.map(i => i.import || 0);
        const allExports = inventoryData.day.map(i => i.export || 0);
        const maxInventory = Math.max(...allImports, ...allExports);

        let currentInventoryMode = 'day';

        const inventoryChart = new Chart(inventoryCtx, {
            type: 'bar',
            data: buildInventoryDataset('day'),
            options: {
                responsive: true,
                plugins: {
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                // Bỏ hiển thị giá trị, chỉ giữ label
                                return context.dataset.label;
                            },
                            afterLabel: function(context) {
                                const index = context.dataIndex;
                                const data = inventoryData[currentInventoryMode][index];
                                
                                if (context.datasetIndex === 0) {
                                    // Nhập kho
                                    return 'Số lần nhập: ' + (data.import_count || 0);
                                } else if (context.datasetIndex === 1) {
                                    // Xuất kho
                                    return 'Số lần xuất: ' + (data.export_count || 0);
                                }
                                return '';
                            },
                            footer: function(tooltipItems) {
                                const index = tooltipItems[0].dataIndex;
                                const data = inventoryData[currentInventoryMode][index];
                                
                                let footer = [];
                                
                                if (tooltipItems[0].datasetIndex === 0 && data.import_details && data.import_details.length > 0) {
                                    // Hiển thị nguyên liệu nhập
                                    footer.push('─────────────────');
                                    footer.push('Top nguyên liệu nhập:');
                                    data.import_details.forEach(item => {
                                        footer.push('• ' + item);
                                    });
                                } else if (tooltipItems[0].datasetIndex === 1 && data.export_details && data.export_details.length > 0) {
                                    // Hiển thị nguyên liệu xuất
                                    footer.push('─────────────────');
                                    footer.push('Top nguyên liệu xuất:');
                                    data.export_details.forEach(item => {
                                        footer.push('• ' + item);
                                    });
                                }
                                
                                return footer.join('\n');
                            }
                        }
                    },
                    legend: {
                        position: 'bottom'
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        min: 0,
                        max: Math.max(50, Math.ceil(maxInventory / 10) * 10),
                        ticks: {
                            stepSize: 5,
                            precision: 0
                        },
                        title: {
                            display: true,
                            text: 'Số lượng'
                        }
                    }
                }
            }
        });

        function buildInventoryDataset(mode) {
            currentInventoryMode = mode;
            
            return {
                labels: inventoryData[mode].map(i => i.label),
                datasets: [
                    {
                        label: 'Nhập kho',
                        data: inventoryData[mode].map(i => i.import || 0),
                        backgroundColor: '#28a745',
                        yAxisID: 'y'
                    },
                    {
                        label: 'Xuất kho',
                        data: inventoryData[mode].map(i => i.export || 0),
                        backgroundColor: '#dc3545',
                        yAxisID: 'y'
                    }
                ]
            };
        }

        // Event listener cho tabs nhập xuất kho
        document.querySelectorAll('[data-chart="inventory"]').forEach(tab => {
            tab.addEventListener('click', function () {
                document.querySelectorAll('[data-chart="inventory"]').forEach(t => t.classList.remove('active'));
                this.classList.add('active');

                const mode = this.dataset.mode;
                
                // Tính lại max cho mode mới
                const imports = inventoryData[mode].map(i => i.import || 0);
                const exports = inventoryData[mode].map(i => i.export || 0);
                const newMax = Math.max(...imports, ...exports);
                
                inventoryChart.options.scales.y.max = Math.max(50, Math.ceil(newMax / 10) * 10);
                inventoryChart.data = buildInventoryDataset(mode);
                inventoryChart.update();
            });
        });


            const retentionData = {
                    day: {{ retention_day|tojson }},
                    week: {{ retention_week|tojson }},
                    month: {{ retention_month|tojson }}
                };

                const ctx = document.getElementById('retentionChart').getContext('2d');

            const customers = retentionData.day.map(i => (i.new || 0) + (i.returning || 0));
            const maxCustomers = Math.max(...customers);

            // Biến để track mode hiện tại
            let currentMode = 'day';

            const chart = new Chart(ctx, {
                type: 'bar',
                data: buildDataset('day'),
                options: {
                    responsive: true,
                    plugins: {
                        tooltip: {
                            callbacks: {
                                afterLabel: function(context) {
                                    const index = context.dataIndex;
                                    const data = retentionData[currentMode][index];
                                    
                                    if (context.datasetIndex === 0) {
                                        // Khách mới
                                        return 'Doanh thu: ' + (data.new_revenue || 0).toLocaleString() + ' đ';
                                    } else if (context.datasetIndex === 1) {
                                        // Khách quay lại
                                        return 'Doanh thu: ' + (data.returning_revenue || 0).toLocaleString() + ' đ';
                                    }
                                    return '';
                                },
                                footer: function(tooltipItems) {
                                    const index = tooltipItems[0].dataIndex;
                                    const data = retentionData[currentMode][index];
                                    return 'Tổng doanh thu: ' + (data.total_revenue || 0).toLocaleString() + ' đ';
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            min: 0,
                            max: Math.max(30, Math.ceil(maxCustomers / 2) * 2),
                            ticks: {
                                stepSize: 2,
                                precision: 0
                            },
                            title: {
                                display: true,
                                text: 'Số khách'
                            }
                        }
                    }
                }
            });

                function buildDataset(mode) {
                    currentMode = mode; // Lưu mode hiện tại
                    
                    return {
                        labels: retentionData[mode].map(i => i.label),
                        datasets: [
                            {
                                label: 'Khách mới',
                                data: retentionData[mode].map(i => i.new || 0),
                                backgroundColor: '#3b7ddd',
                                yAxisID: 'y'
                            },
                            {
                                label: 'Khách quay lại',
                                data: retentionData[mode].map(i => i.returning || 0),
                                backgroundColor: '#28a745',
                                yAxisID: 'y'
                            }
                        ]
                    };
                }


                document.querySelectorAll('.nav-link').forEach(tab => {
                    tab.addEventListener('click', function () {
                        document.querySelectorAll('.nav-link').forEach(t => t.classList.remove('active'));
                        this.classList.add('active');

                        const mode = this.dataset.mode;
                        chart.data = buildDataset(mode);
                        chart.update();
                    });
                });


            // Dữ liệu cho biểu đồ doanh thu 7 ngày gần nhất
            var revenueCtx = document.getElementById('revenueChart').getContext('2d');
            var revenueChart = new Chart(revenueCtx, {
                type: 'line',
                data: {
                    labels: {{ day_labels|tojson }},
                    datasets: [{
                        label: 'Doanh thu (đ)',
                        data: {{ revenue_by_day|tojson }},
                        backgroundColor: 'rgba(59, 125, 221, 0.1)',
                        borderColor: 'rgba(59, 125, 221, 1)',
                        borderWidth: 2,
                        pointBackgroundColor: 'rgba(59, 125, 221, 1)',
                        pointBorderColor: '#fff',
                        pointHoverBackgroundColor: '#fff',
                        pointHoverBorderColor: 'rgba(59, 125, 221, 1)',
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return value.toLocaleString() + 'đ';
                                }
                            }
                        }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.dataset.label + ': ' + context.raw.toLocaleString() + 'đ';
                                }
                            }
                        }
                    }
                }
            });

            // Biểu đồ tỷ lệ đơn hàng theo trạng thái
            var orderStatusCtx = document.getElementById('orderStatusChart').getContext('2d');
            var statusLabels = [];
            var statusData = [];
            var statusColors = {
                'pending': '#FFA500',
                'in_progress': '#3b7ddd',
                'completed': '#28a745',
                'cancelled': '#dc3545'
            };
            var backgroundColors = [];

            {% for status in order_status_counts %}
                statusLabels.push('{{ status.status }}' === 'pending' ? 'Chờ' : 
                                '{{ status.status }}' === 'in_progress' ? 'Đang làm' : 
                                '{{ status.status }}' === 'completed' ? 'Hoàn thành' : 'Hủy');
                statusData.push({{ status.count }});
                backgroundColors.push(statusColors['{{ status.status }}']);
            {% endfor %}

            var orderStatusChart = new Chart(orderStatusCtx, {
                type: 'doughnut',
                data: {
                    labels: statusLabels,
                    datasets: [{
                        data: statusData,
                        backgroundColor: backgroundColors,
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });

            // Biểu đồ doanh thu theo danh mục
            var categoryCtx = document.getElementById('categoryRevenueChart').getContext('2d');
            var categoryLabels = [];
            var categoryData = [];
            
            {% for category in revenue_by_category %}
                categoryLabels.push('{{ category.product__category__name }}');
                categoryData.push({{ category.total }});
            {% endfor %}
            
            var categoryRevenueChart = new Chart(categoryCtx, {
                type: 'bar',
                data: {
                    labels: categoryLabels,
                    datasets: [{
                        label: 'Doanh thu (đ)',
                        data: categoryData,
                        backgroundColor: 'rgba(59, 125, 221, 0.7)',
                        borderColor: 'rgba(59, 125, 221, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return value.toLocaleString() + 'đ';
                                }
                            }
                        }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.dataset.label + ': ' + context.raw.toLocaleString() + 'đ';
                                }
                            }
                        }
                    }
                }
            });

            // Biểu đồ tồn kho nguyên liệu
            var ingredientCtx = document.getElementById('ingredientStockChart').getContext('2d');
            var ingredientChart = new Chart(ingredientCtx, {
                type: 'horizontalBar',
                data: {
                    labels: {{ ingredient_labels|tojson }},
                    datasets: [{
                        label: 'Số lượng tồn kho',
                        data: {{ ingredient_stocks|tojson }},
                        backgroundColor: 'rgba(40, 167, 69, 0.7)',
                        borderColor: 'rgba(40, 167, 69, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            beginAtZero: true
                        }
                    }
                }
            });
        });
</script>
{% endblock %}